<html>
<body>
<div id="audio"></div>
<style>
	div.story {
		margin: auto;
		//margin: 2px 10px 2px 10px;
		max-width: 100px;
		text-align: center;
		border-style: solid;
		border-width: 2px;
		border-radius: 10px;
		background-color: lightgray;
	}
</style>
<div class="story", id="story">
	<div class="options"></div>
</div>	
<script src="scripts/taffy-min.js"></script>
<script src="scripts/speakClient.js"></script>
<script src="scripts/annyang.min.js"></script>
<script>
	var CYOA_DB = TAFFY([
		{ "page":0, "story":"You are lost in the woods. Would you like to go left down a path, or go right down another path?", "option":"go left/go right", "go":"3/1" },
		{ "page":1, "story":"You are lost in the woods. Would you like to go left off the path, or go down a nearby hole?", "option":"go left/go down", "go":"0/2" },
		{ "page":2, "story":"You are stuck in a hole. Would you like to climb out, or would you like to cry me a river?", "option":"climb out/cry (me) a river", "go":"1/4" }
	]);
	var currentPage = 0;
	var currentStory;
	var readStory = function() {
		currentStory = CYOA_DB({page:currentPage}).select("story");
		document.getElementById("story").innerHTML = currentStory;
		speak(currentStory[0]);
	};
	readStory();
	//annyang.addCallback('end', readStory);
	annyang.addCallback('result', function(phrases) {
		speak(currentStory[0]);
		var list = CYOA_DB().select("option");
		var nextPage = -1;
		for(phrase=0; phrase<phrases.length; phrase++) {
			for(i=0; i<list.length; i++) {
				var options = list[i].split("/");
				for(y=0; y<options.length; y++) {
					//console.log("Comparing '" + phrases[phrase] + "' to '" + options[y] + "'...");
					if(phrases[phrase].search(options[y]) >= 0) {
						var goOpts = CYOA_DB().select("go")[i];
						nextPage=goOpts.split("/")[y];
						currentPage=parseInt(nextPage);
						readStory();
						//speak("An option has been matched");
						break;
					}
				}
				if(nextPage != -1) { break; }
			}
			if(nextPage != -1) { break; }
		}
		if(nextPage == -1) { speak("Could you repeat that?"); }
		//document.getElementByClass("options")
	});	
	//annyang.addCommands(commands);
	annyang.start();
</script>
</body>
</head>
</html>